<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Playground - QA Engineering Playbook</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <link rel="stylesheet" href="styles.css?v=2.7">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Pyodide for Python execution -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <style>
        .py-status {
            font-size: 0.75rem;
            margin-left: 4px;
        }
        #runBtn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <div id="nav-placeholder"></div>

    <!-- Page Header -->
    <section class="page-header" style="padding: 2rem 0;">
        <div class="container">
            <h1>üíª Code Playground</h1>
            <p>Write, test, and experiment with code examples in real-time</p>
        </div>
    </section>

    <!-- Playground Content -->
    <section class="content-section" style="padding-top: 1rem;">
        <div class="playground-container">
            <!-- Controls -->
            <div class="playground-controls">
                <div class="language-selector">
                    <button class="lang-btn active" data-lang="javascript" onclick="switchLanguage('javascript')">
                        JavaScript
                    </button>
                    <button class="lang-btn" data-lang="html" onclick="switchLanguage('html')">
                        HTML/CSS
                    </button>
                    <button class="lang-btn" data-lang="python" onclick="switchLanguage('python')">
                        Python <span id="pyStatus" class="py-status"></span>
                    </button>
                </div>

                <div class="playground-actions">
                    <button id="runBtn" class="btn btn-primary" onclick="runCode()" title="Ctrl+Enter">‚ñ∂Ô∏è Run</button>
                    <button class="btn btn-outline" onclick="clearOutput()">üóëÔ∏è Clear</button>
                    <button class="btn btn-outline" onclick="resetCode()">‚Üª Reset</button>
                    <button class="btn btn-outline" onclick="shareCode()">üì§ Share</button>
                </div>
            </div>

            <!-- Editor & Output -->
            <div class="playground-editor-container">
                <!-- Code Editor -->
                <div class="editor-panel">
                    <div class="panel-header">
                        <span id="editorLabel">JavaScript Code</span>
                        <div class="editor-tools">
                            <button class="tool-btn" onclick="formatCode()" title="Format Code">
                                üé®
                            </button>
                            <button class="tool-btn" onclick="copyCode()" title="Copy Code">
                                üìã
                            </button>
                        </div>
                    </div>
                    <textarea id="codeEditor" class="code-editor" spellcheck="false"></textarea>
                </div>

                <!-- Output Panel -->
                <div class="output-panel">
                    <div class="panel-header">
                        <span>Output</span>
                        <span id="executionTime" class="execution-time"></span>
                    </div>
                    <div id="output" class="output-content"></div>
                </div>
            </div>

            <!-- Examples -->
            <div class="playground-examples">
                <h3>üìö Quick Examples</h3>
                <div class="examples-grid" id="examplesGrid"></div>
            </div>
        </div>
    </section>

    <script src="nav.js"></script>
    <script src="app.js?v=2.7"></script>
    <script>
        let currentLanguage = 'javascript';
        let pyodide = null;
        let pyodideLoading = false;
        let pyodideReady = false;

        const examples = {
            javascript: [
                {
                    title: 'Hello World',
                    code: `console.log('Hello, QA Playground!');

// Test a simple function
function greet(name) {
    return \`Hello, \${name}!\`;
}

console.log(greet('QA Engineer'));`
                },
                {
                    title: 'Array Operations',
                    code: `// Test data
const users = [
    { name: 'Alice', role: 'QA' },
    { name: 'Bob', role: 'Dev' },
    { name: 'Charlie', role: 'QA' }
];

// Filter QA engineers
const qaEngineers = users.filter(u => u.role === 'QA');
console.log('QA Engineers:', qaEngineers);

// Map names
const names = users.map(u => u.name);
console.log('Names:', names);`
                },
                {
                    title: 'API Response Validation',
                    code: `// Mock API response
const apiResponse = {
    status: 200,
    data: {
        id: 123,
        name: 'Test User',
        email: 'test@example.com'
    }
};

// Validation function
function validateResponse(response) {
    const checks = {
        'Status is 200': response.status === 200,
        'Has data': !!response.data,
        'Has id': !!response.data?.id,
        'Has valid email': /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(response.data?.email)
    };

    console.log('Validation Results:');
    Object.entries(checks).forEach(([check, passed]) => {
        console.log(\`  \${passed ? '‚úÖ' : '‚ùå'} \${check}\`);
    });
}

validateResponse(apiResponse);`
                }
            ],
            html: [
                {
                    title: 'Simple Page',
                    code: `<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .card {
            background: white;
            color: #333;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>Hello from the Playground!</h1>
        <p>This is a test page rendered in an iframe.</p>
    </div>
</body>
</html>`
                },
                {
                    title: 'Interactive Button',
                    code: `<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
        }
        button {
            padding: 15px 30px;
            font-size: 18px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        button:hover {
            background: #2563eb;
        }
    </style>
</head>
<body>
    <button onclick="alert('Button clicked!')">Click Me!</button>
</body>
</html>`
                },
                {
                    title: 'Responsive Layout',
                    code: `<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .box {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>Responsive Grid</h1>
    <div class="grid">
        <div class="box">Box 1</div>
        <div class="box">Box 2</div>
        <div class="box">Box 3</div>
    </div>
</body>
</html>`
                }
            ],
            python: [
                {
                    title: 'Hello World',
                    code: `print("Hello, QA Playground!")

# Test a simple function
def greet(name):
    return f"Hello, {name}!"

print(greet("QA Engineer"))`
                },
                {
                    title: 'List Operations',
                    code: `# Test data
users = [
    {"name": "Alice", "role": "QA"},
    {"name": "Bob", "role": "Dev"},
    {"name": "Charlie", "role": "QA"}
]

# Filter QA engineers
qa_engineers = [u for u in users if u["role"] == "QA"]
print("QA Engineers:", qa_engineers)

# Get names
names = [u["name"] for u in users]
print("Names:", names)`
                },
                {
                    title: 'Test Assertions',
                    code: `# Test assertions example
def test_calculator():
    # Test addition
    result = 2 + 2
    assert result == 4, f"Expected 4, got {result}"
    print("‚úÖ Addition test passed")

    # Test multiplication
    result = 5 * 3
    assert result == 15, f"Expected 15, got {result}"
    print("‚úÖ Multiplication test passed")

    # Test division
    result = 10 / 2
    assert result == 5, f"Expected 5, got {result}"
    print("‚úÖ Division test passed")

test_calculator()
print("\\nüéâ All tests passed!")`
                }
            ]
        };

        const defaultCode = {
            javascript: `// Write your JavaScript code here
console.log('Welcome to the QA Playground!');

// Example: Test a function
function sum(a, b) {
    return a + b;
}

console.log('2 + 3 =', sum(2, 3));`,
            html: `<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        h1 {
            color: #3b82f6;
        }
    </style>
</head>
<body>
    <h1>Hello from HTML!</h1>
    <p>Edit the HTML and see the changes in real-time.</p>
</body>
</html>`,
            python: `# Write your Python code here
print("Welcome to the Python Playground!")

# Example: Test a function
def sum_numbers(a, b):
    return a + b

print(f"2 + 3 = {sum_numbers(2, 3)}")`
        };

        document.addEventListener('DOMContentLoaded', () => {
            // Check for shared code in URL first
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('code')) {
                try {
                    const code = decodeURIComponent(atob(urlParams.get('code')));
                    const lang = urlParams.get('lang') || 'javascript';
                    currentLanguage = lang;
                    document.getElementById('codeEditor').value = code;

                    // Update UI for the language
                    document.querySelectorAll('.lang-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.lang === lang);
                    });
                    const labels = { javascript: 'JavaScript Code', html: 'HTML Code', python: 'Python Code' };
                    document.getElementById('editorLabel').textContent = labels[lang];
                } catch (error) {
                    console.error('Failed to load shared code:', error);
                    loadDefaultCode();
                }
            } else {
                loadDefaultCode();
            }

            loadExamples();

            // Add keyboard shortcuts
            document.getElementById('codeEditor').addEventListener('keydown', (e) => {
                // Ctrl/Cmd + Enter to run
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    runCode();
                }
                // Tab for indentation
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = e.target.selectionStart;
                    const end = e.target.selectionEnd;
                    e.target.value = e.target.value.substring(0, start) + '    ' + e.target.value.substring(end);
                    e.target.selectionStart = e.target.selectionEnd = start + 4;
                }
            });

            // Pre-load Pyodide in background
            loadPyodide();
        });

        async function loadPyodide() {
            if (pyodideReady || pyodideLoading) return;
            pyodideLoading = true;

            const pyStatus = document.getElementById('pyStatus');
            pyStatus.textContent = '‚è≥';
            pyStatus.title = 'Loading Python...';

            try {
                pyodide = await globalThis.loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"
                });
                pyodideReady = true;
                pyStatus.textContent = '‚úì';
                pyStatus.title = 'Python ready';
                pyStatus.style.color = '#10b981';
                console.log('Pyodide loaded successfully');
            } catch (error) {
                console.error('Failed to load Pyodide:', error);
                pyStatus.textContent = '‚úó';
                pyStatus.title = 'Failed to load Python';
                pyStatus.style.color = '#ef4444';
                pyodideLoading = false;
            }
        }

        function loadDefaultCode() {
            document.getElementById('codeEditor').value = defaultCode[currentLanguage];
        }

        function switchLanguage(lang) {
            currentLanguage = lang;

            // Update active button
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === lang);
            });

            // Update editor label
            const labels = {
                javascript: 'JavaScript Code',
                html: 'HTML Code',
                python: 'Python Code'
            };
            document.getElementById('editorLabel').textContent = labels[lang];

            // Load default code
            if (!document.getElementById('codeEditor').value.trim()) {
                loadDefaultCode();
            }

            // Load examples
            loadExamples();

            // Clear output
            clearOutput();
        }

        function loadExamples() {
            const grid = document.getElementById('examplesGrid');
            grid.innerHTML = examples[currentLanguage].map((example, index) => `
                <button class="example-card" onclick="loadExample(${index})">
                    <span class="example-icon">üìù</span>
                    <span class="example-title">${example.title}</span>
                </button>
            `).join('');
        }

        function loadExample(index) {
            const example = examples[currentLanguage][index];
            document.getElementById('codeEditor').value = example.code;
            clearOutput();
        }

        async function runCode() {
            const code = document.getElementById('codeEditor').value;
            const output = document.getElementById('output');
            const runBtn = document.getElementById('runBtn');
            const startTime = performance.now();

            // Disable button during execution
            runBtn.disabled = true;
            runBtn.textContent = '‚è≥ Running...';

            clearOutput();

            try {
                if (currentLanguage === 'javascript') {
                    runJavaScript(code, output);
                } else if (currentLanguage === 'html') {
                    runHTML(code, output);
                } else if (currentLanguage === 'python') {
                    await runPython(code, output);
                }
            } finally {
                // Re-enable button
                runBtn.disabled = false;
                runBtn.textContent = '‚ñ∂Ô∏è Run';

                const endTime = performance.now();
                document.getElementById('executionTime').textContent =
                    `‚è±Ô∏è ${(endTime - startTime).toFixed(2)}ms`;
            }
        }

        function runJavaScript(code, output) {
            const originalLog = console.log;
            const logs = [];

            console.log = function(...args) {
                logs.push(args.map(arg =>
                    typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
                ).join(' '));
            };

            try {
                eval(code);
                output.innerHTML = logs.map(log =>
                    `<div class="output-line">${escapeHtml(log)}</div>`
                ).join('');

                if (logs.length === 0) {
                    output.innerHTML = '<div class="output-info">‚úÖ Code executed successfully (no output)</div>';
                }
            } catch (error) {
                output.innerHTML = `<div class="output-error">‚ùå Error: ${escapeHtml(error.message)}</div>`;
            } finally {
                console.log = originalLog;
            }
        }

        function runHTML(code, output) {
            const iframe = document.createElement('iframe');
            iframe.className = 'html-preview';
            output.appendChild(iframe);

            iframe.contentDocument.open();
            iframe.contentDocument.write(code);
            iframe.contentDocument.close();
        }

        async function runPython(code, output) {
            if (!pyodideReady) {
                output.innerHTML = `
                    <div class="output-info">
                        ‚è≥ Loading Python interpreter... Please wait.
                    </div>
                `;

                // Try to load if not already loading
                if (!pyodideLoading) {
                    await loadPyodide();
                } else {
                    // Wait for it to finish loading
                    while (pyodideLoading && !pyodideReady) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }

                if (!pyodideReady) {
                    output.innerHTML = `
                        <div class="output-error">
                            ‚ùå Failed to load Python interpreter. Please refresh the page and try again.
                        </div>
                    `;
                    return;
                }
            }

            try {
                // Redirect stdout to capture print statements
                pyodide.runPython(`
import sys
from io import StringIO
sys.stdout = StringIO()
sys.stderr = StringIO()
                `);

                // Run the user's code
                pyodide.runPython(code);

                // Get the output
                const stdout = pyodide.runPython('sys.stdout.getvalue()');
                const stderr = pyodide.runPython('sys.stderr.getvalue()');

                // Reset stdout/stderr
                pyodide.runPython(`
sys.stdout = sys.__stdout__
sys.stderr = sys.__stderr__
                `);

                if (stderr) {
                    output.innerHTML = `<div class="output-error">‚ùå ${escapeHtml(stderr)}</div>`;
                } else if (stdout) {
                    output.innerHTML = stdout.split('\n')
                        .filter(line => line !== '')
                        .map(line => `<div class="output-line">${escapeHtml(line)}</div>`)
                        .join('');
                } else {
                    output.innerHTML = '<div class="output-info">‚úÖ Code executed successfully (no output)</div>';
                }
            } catch (error) {
                output.innerHTML = `<div class="output-error">‚ùå Error: ${escapeHtml(error.message)}</div>`;
            }
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '';
            document.getElementById('executionTime').textContent = '';
        }

        function resetCode() {
            if (confirm('Reset to default code? Your current code will be lost.')) {
                document.getElementById('codeEditor').value = defaultCode[currentLanguage];
                clearOutput();
            }
        }

        function formatCode() {
            const editor = document.getElementById('codeEditor');
            const code = editor.value;

            // Basic formatting (indentation)
            const lines = code.split('\n');
            let indentLevel = 0;
            const formatted = lines.map(line => {
                const trimmed = line.trim();

                if (trimmed.endsWith('{') || trimmed.endsWith('[') || trimmed.endsWith('(')) {
                    const result = '    '.repeat(indentLevel) + trimmed;
                    indentLevel++;
                    return result;
                } else if (trimmed.startsWith('}') || trimmed.startsWith(']') || trimmed.startsWith(')')) {
                    indentLevel = Math.max(0, indentLevel - 1);
                    return '    '.repeat(indentLevel) + trimmed;
                } else {
                    return '    '.repeat(indentLevel) + trimmed;
                }
            }).join('\n');

            editor.value = formatted;
        }

        function copyCode() {
            const code = document.getElementById('codeEditor').value;
            navigator.clipboard.writeText(code).then(() => {
                alert('‚úÖ Code copied to clipboard!');
            });
        }

        function shareCode() {
            const code = document.getElementById('codeEditor').value;
            const encoded = btoa(encodeURIComponent(code));
            const url = `${window.location.origin}${window.location.pathname}?code=${encoded}&lang=${currentLanguage}`;

            navigator.clipboard.writeText(url).then(() => {
                alert('‚úÖ Share link copied to clipboard!');
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
