<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson - QA Engineering Playbook</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <link rel="stylesheet" href="styles.css?v=2.6">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        if (typeof mermaid !== 'undefined') {
            mermaid.initialize({ startOnLoad: true, theme: 'default' });
        }
    </script>
</head>
<body>
    <!-- Navigation -->
    <div id="nav-placeholder"></div>

    <!-- Reading Progress Bar -->
    <div class="reading-progress"></div>

    <!-- Lesson Content -->
    <section class="content-section">
        <div class="container" style="max-width: 900px;">
            <div id="lessonContent">
                <p>Loading lesson...</p>
            </div>
        </div>
    </section>

    <!-- Notes & Bookmarks Panel -->
    <button class="notes-toggle" id="notesToggle" title="Toggle Notes & Bookmarks">
        üìù
    </button>

    <div class="notes-panel" id="notesPanel">
        <div class="notes-header">
            <h3>Notes & Bookmarks</h3>
            <button class="close-panel" onclick="toggleNotesPanel()">√ó</button>
        </div>

        <div class="notes-tabs">
            <button class="notes-tab active" onclick="switchTab('notes')">üìù Notes</button>
            <button class="notes-tab" onclick="switchTab('bookmarks')">üîñ Bookmarks</button>
        </div>

        <div id="notesTab" class="tab-content">
            <textarea
                id="lessonNotes"
                placeholder="Take notes for this lesson..."
                class="notes-textarea"
            ></textarea>
            <button class="btn btn-primary btn-small" onclick="saveNotes()" style="margin-top: 1rem; width: 100%;">
                Save Notes
            </button>
        </div>

        <div id="bookmarksTab" class="tab-content" style="display: none;">
            <button class="btn btn-primary btn-small" onclick="toggleBookmark()" id="bookmarkBtn" style="width: 100%; margin-bottom: 1rem;">
                üîñ Bookmark This Lesson
            </button>
            <div id="bookmarksList"></div>
        </div>
    </div>

    <script src="nav.js"></script>
    <script src="app.js?v=2.6"></script>
    <script>
        let currentModuleId, currentLessonId;

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            currentModuleId = parseInt(urlParams.get('module'));
            currentLessonId = parseInt(urlParams.get('lesson'));

            if (isNaN(currentModuleId) || isNaN(currentLessonId)) {
                window.location.href = 'modules.html';
                return;
            }

            const module = modules.find(m => m.id === currentModuleId);
            if (!module || currentLessonId >= module.lessons_list.length) {
                window.location.href = 'modules.html';
                return;
            }

            loadLesson(module, currentLessonId);
            setupReadingProgress();
            setupNotesPanel();
            loadNotes();
            loadBookmarks();
        });

        async function loadLesson(module, lessonIndex) {
            const lesson = module.lessons_list[lessonIndex];
            const isObject = lesson && typeof lesson === 'object' && !Array.isArray(lesson);
            const lessonTitle = isObject ? lesson.title : lesson;
            const lessonFile = isObject && lesson.file ? lesson.file : null;

            if (!lessonFile) {
                document.getElementById('lessonContent').innerHTML = `
                    <div class="lesson-nav">
                        <a href="module.html?id=${module.id}" class="btn btn-outline">‚Üê Back to Module</a>
                    </div>
                    <h1>${lessonTitle}</h1>
                    <p style="color: var(--gray); font-size: 1.2rem;">This lesson is coming soon!</p>
                `;
                return;
            }

            try {
                const response = await fetch(lessonFile);
                if (!response.ok) throw new Error('Lesson not found');

                const markdown = await response.text();
                const html = convertMarkdownToHTML(markdown);

                const lessonKey = `${module.id}-${lessonIndex}`;
                const isCompleted = progress.lessons[lessonKey];

                // Navigation buttons
                const prevLesson = lessonIndex > 0 ? lessonIndex - 1 : null;
                const nextLesson = lessonIndex < module.lessons_list.length - 1 ? lessonIndex + 1 : null;

                document.getElementById('lessonContent').innerHTML = `
                    <div class="lesson-nav">
                        <div>
                            <a href="module.html?id=${module.id}" class="btn btn-outline btn-small">‚Üê Module</a>
                            ${prevLesson !== null ? `<a href="lesson.html?module=${module.id}&lesson=${prevLesson}" class="btn btn-outline btn-small">‚Üê Previous</a>` : ''}
                        </div>
                        <div>
                            <button class="btn btn-primary btn-small" onclick="toggleLessonComplete()">
                                ${isCompleted ? '‚úÖ Completed' : 'Mark Complete'}
                            </button>
                            ${nextLesson !== null ? `<a href="lesson.html?module=${module.id}&lesson=${nextLesson}" class="btn btn-primary btn-small">Next ‚Üí</a>` : ''}
                        </div>
                    </div>
                    <div class="lesson-body">
                        ${html}
                    </div>
                    <div class="lesson-nav" style="margin-top: 3rem; border-top: 2px solid var(--gray-light); padding-top: 2rem;">
                        <div>
                            ${prevLesson !== null ? `<a href="lesson.html?module=${module.id}&lesson=${prevLesson}" class="btn btn-outline">‚Üê Previous Lesson</a>` : ''}
                        </div>
                        <div>
                            ${nextLesson !== null ? `<a href="lesson.html?module=${module.id}&lesson=${nextLesson}" class="btn btn-primary">Next Lesson ‚Üí</a>` : `<a href="module.html?id=${module.id}" class="btn btn-primary">Back to Module</a>`}
                        </div>
                    </div>
                `;

                // Scroll to top
                window.scrollTo(0, 0);

            } catch (error) {
                console.error('Error loading lesson:', error);
                document.getElementById('lessonContent').innerHTML = `
                    <div class="lesson-nav">
                        <a href="module.html?id=${module.id}" class="btn btn-outline">‚Üê Back to Module</a>
                    </div>
                    <h1>Error Loading Lesson</h1>
                    <p style="color: var(--gray);">Failed to load lesson content. Please try again later.</p>
                `;
            }
        }

        function toggleLessonComplete() {
            const lessonKey = `${currentModuleId}-${currentLessonId}`;
            const isCompleted = progress.lessons[lessonKey];

            if (isCompleted) {
                delete progress.lessons[lessonKey];
            } else {
                progress.lessons[lessonKey] = true;

                // Track completion date for streak
                if (!progress.completionDates) {
                    progress.completionDates = [];
                }
                progress.completionDates.push(new Date().toISOString());
            }

            // Update module progress
            const module = modules.find(m => m.id === currentModuleId);
            const completedLessons = Object.keys(progress.lessons).filter(key =>
                key.startsWith(`${currentModuleId}-`) && progress.lessons[key]
            ).length;
            progress.modules[currentModuleId] = completedLessons;

            localStorage.setItem('qaPlaybookProgress', JSON.stringify(progress));

            // Reload page to update UI
            location.reload();
        }

        function setupReadingProgress() {
            const progressBar = document.querySelector('.reading-progress');
            if (!progressBar) return;

            window.addEventListener('scroll', () => {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
                const scrollPercent = (scrollTop / scrollHeight) * 100;
                progressBar.style.width = scrollPercent + '%';
            });
        }

        // Notes & Bookmarks Functions
        function setupNotesPanel() {
            const toggle = document.getElementById('notesToggle');
            toggle.addEventListener('click', toggleNotesPanel);
        }

        function toggleNotesPanel() {
            const panel = document.getElementById('notesPanel');
            panel.classList.toggle('open');
        }

        function switchTab(tab) {
            const notesTab = document.getElementById('notesTab');
            const bookmarksTab = document.getElementById('bookmarksTab');
            const tabs = document.querySelectorAll('.notes-tab');

            tabs.forEach(t => t.classList.remove('active'));

            if (tab === 'notes') {
                notesTab.style.display = 'block';
                bookmarksTab.style.display = 'none';
                tabs[0].classList.add('active');
            } else {
                notesTab.style.display = 'none';
                bookmarksTab.style.display = 'block';
                tabs[1].classList.add('active');
            }
        }

        function loadNotes() {
            const lessonKey = `${currentModuleId}-${currentLessonId}`;
            const notes = JSON.parse(localStorage.getItem('qaPlaybookNotes') || '{}');
            const lessonNotes = notes[lessonKey] || '';

            document.getElementById('lessonNotes').value = lessonNotes;
        }

        function saveNotes() {
            const lessonKey = `${currentModuleId}-${currentLessonId}`;
            const notes = JSON.parse(localStorage.getItem('qaPlaybookNotes') || '{}');
            notes[lessonKey] = document.getElementById('lessonNotes').value;

            localStorage.setItem('qaPlaybookNotes', JSON.stringify(notes));
            alert('‚úÖ Notes saved!');
        }

        function loadBookmarks() {
            const bookmarks = JSON.parse(localStorage.getItem('qaPlaybookBookmarks') || '[]');
            const lessonKey = `${currentModuleId}-${currentLessonId}`;

            // Update bookmark button
            const isBookmarked = bookmarks.some(b => b.key === lessonKey);
            const btn = document.getElementById('bookmarkBtn');
            btn.textContent = isBookmarked ? 'üîñ Remove Bookmark' : 'üîñ Bookmark This Lesson';

            // Display all bookmarks
            displayBookmarks();
        }

        function toggleBookmark() {
            const bookmarks = JSON.parse(localStorage.getItem('qaPlaybookBookmarks') || '[]');
            const lessonKey = `${currentModuleId}-${currentLessonId}`;
            const module = modules.find(m => m.id === currentModuleId);
            const lesson = module.lessons_list[currentLessonId];
            const lessonTitle = (typeof lesson === 'object') ? lesson.title : lesson;

            const existingIndex = bookmarks.findIndex(b => b.key === lessonKey);

            if (existingIndex >= 0) {
                // Remove bookmark
                bookmarks.splice(existingIndex, 1);
                alert('üîñ Bookmark removed');
            } else {
                // Add bookmark
                bookmarks.push({
                    key: lessonKey,
                    moduleId: currentModuleId,
                    lessonId: currentLessonId,
                    moduleTitle: module.title,
                    lessonTitle: lessonTitle,
                    date: new Date().toISOString()
                });
                alert('‚úÖ Lesson bookmarked!');
            }

            localStorage.setItem('qaPlaybookBookmarks', JSON.stringify(bookmarks));
            loadBookmarks();
        }

        function displayBookmarks() {
            const bookmarks = JSON.parse(localStorage.getItem('qaPlaybookBookmarks') || '[]');
            const list = document.getElementById('bookmarksList');

            if (bookmarks.length === 0) {
                list.innerHTML = '<p style="color: var(--gray); text-align: center; padding: 2rem;">No bookmarks yet</p>';
                return;
            }

            let html = '<div class="bookmarks-list">';
            bookmarks.reverse().forEach(bookmark => {
                html += `
                    <div class="bookmark-item">
                        <a href="lesson.html?module=${bookmark.moduleId}&lesson=${bookmark.lessonId}">
                            <strong>${bookmark.lessonTitle}</strong>
                            <span>${bookmark.moduleTitle}</span>
                        </a>
                    </div>
                `;
            });
            html += '</div>';

            list.innerHTML = html;
        }
    </script>
</body>
</html>
